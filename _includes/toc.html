{% comment %}
  Table of Contents Generator
  Automatically generates a TOC from h2, h3, h4 headings in the article
{% endcomment %}

<div class="toc" id="toc">
  <h3 class="toc-title">Table of Contents</h3>
  <ul class="toc-list" id="toc-list">
    <!-- Generated by JavaScript -->
  </ul>
</div>

<script>
(function() {
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateTOC);
  } else {
    generateTOC();
  }

  function generateTOC() {
    const tocList = document.getElementById('toc-list');
    if (!tocList) return;

    const article = document.querySelector('.article');
    if (!article) return;

    const headings = article.querySelectorAll('h2, h3, h4');
    if (headings.length === 0) {
      // Hide TOC if no headings found
      document.getElementById('toc').style.display = 'none';
      return;
    }

    const tocItems = [];
    
    headings.forEach((heading, index) => {
      // Generate ID if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      const level = parseInt(heading.tagName.charAt(1));
      const text = heading.textContent.trim();
      const id = heading.id;

      tocItems.push({
        level: level,
        text: text,
        id: id,
        element: heading
      });
    });

    // Generate HTML
    let html = '';
    tocItems.forEach(item => {
      const className = 'toc-h' + item.level;
      html += `<li><a href="#${item.id}" class="${className}">${item.text}</a></li>`;
    });

    tocList.innerHTML = html;

    // Add smooth scrolling
    tocList.addEventListener('click', function(e) {
      if (e.target.tagName === 'A') {
        e.preventDefault();
        const targetId = e.target.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
          
          // Update URL without jumping
          history.pushState(null, null, '#' + targetId);
        }
      }
    });

    // Highlight current section on scroll
    let currentSection = null;
    
    function updateCurrentSection() {
      const scrollPos = window.scrollY + 100; // Offset for better UX
      
      for (let i = tocItems.length - 1; i >= 0; i--) {
        const item = tocItems[i];
        const element = item.element;
        const rect = element.getBoundingClientRect();
        
        if (rect.top <= scrollPos) {
          if (currentSection !== item.id) {
            // Remove previous highlight
            if (currentSection) {
              const prevLink = tocList.querySelector(`a[href="#${currentSection}"]`);
              if (prevLink) prevLink.classList.remove('active');
            }
            
            // Add new highlight
            const newLink = tocList.querySelector(`a[href="#${item.id}"]`);
            if (newLink) {
              newLink.classList.add('active');
              currentSection = item.id;
            }
          }
          break;
        }
      }
    }

    // Throttled scroll listener
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(function() {
          updateCurrentSection();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll);
    
    // Initial highlight
    updateCurrentSection();
  }
})();
</script>

